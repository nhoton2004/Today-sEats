# Backend (Firebase) Setup

This folder documents the backend setup using Firebase for Today's Eats.

## Stack
- Firebase Auth: email/password login
- Cloud Firestore: dishes, favorites, user profiles, app stats
- Firebase Storage: dish images
- Cloud Functions (Node.js 20+): admin operations, scheduled jobs, security logic

## Project Creation
1. Install Firebase CLI (requires Node.js >= 20):
   - Option A (recommended): use Node 20 via nvm
     ```bash
     sudo apt install curl -y
     curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
     source ~/.bashrc
     nvm install 20
     nvm use 20
     ```
   - Install Firebase CLI:
     ```bash
     npm install -g firebase-tools
     firebase login
     ```

2. Configure Flutter app with FlutterFire CLI:
   ```bash
   dart pub global activate flutterfire_cli
   echo 'export PATH="$PATH":"$HOME/.pub-cache/bin"' >> ~/.bashrc
   source ~/.bashrc
   flutterfire configure --project <your-project-id> --platforms android,ios --out lib/firebase_options.dart
   ```

## Firestore Structure
- `users/{uid}`
  - `displayName`, `email`, `photoURL`, `role` ('user'|'admin')
  - `favorites`: array of dish ids
- `dishes/{dishId}`
  - `name`, `category`, `status` ('active'|'inactive'), `imageUrl`, `rating`
- `app_stats/{statId}`
  - counters and aggregates

## Rules (baseline)
Create `firestore.rules` and deploy with `firebase deploy --only firestore`:
```rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
    }
    match /dishes/{dishId} {
      allow read: if true;
      allow write: if request.auth.token.admin == true; // custom claims
    }
    match /app_stats/{doc} {
      allow read: if request.auth != null && request.auth.token.admin == true;
      allow write: if false;
    }
  }
}
```

## Cloud Functions Scaffold
Initialize in `backend/functions` after `firebase init`:
```bash
cd backend
firebase init functions
# Choose TypeScript, Node 20, ESLint
npm run build
firebase deploy --only functions
```

## Environment
- Android/iOS API keys are stored in `lib/firebase_options.dart` generated by FlutterFire.
- Do not commit service account keys.

## Frontend Wiring
- Auth: email/password via `firebase_auth`
- Data: Firestore reads/writes for favorites and dishes
- Storage: upload images for dishes

Refer to this README while setting up and deploying the backend. 